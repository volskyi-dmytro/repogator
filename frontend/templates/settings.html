<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ app_name }} — Settings</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png" />
  <link rel="shortcut icon" href="/static/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Space Grotesk', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          }
        }
      }
    }
  </script>
  <style>
    body {
      background-color: #0a0f1e;
      background-image: radial-gradient(circle, rgba(0,212,255,0.18) 1px, transparent 1px);
      background-size: 32px 32px;
    }
    .glass-card {
      background: rgba(10,15,30,0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(0,212,255,0.15);
      border-radius: 12px;
    }
    .glass-header {
      background: rgba(10,15,30,0.85);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(0,212,255,0.1);
    }
  </style>
</head>
<body class="min-h-screen text-slate-100 font-sans">

  <!-- Header -->
  <header class="glass-header px-6 py-4 sticky top-0 z-50 relative">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="/dashboard" class="flex items-center gap-2 text-2xl font-bold tracking-tight">
          <img src="/static/logo-128.png" class="h-9 w-9 object-contain" alt="RepoGator logo" />
          <span class="text-white">{{ app_name }}</span>
        </a>
      </div>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="/dashboard" class="text-slate-400 hover:text-[#00d4ff] transition-colors">Dashboard</a>
        <a href="/repos" class="text-slate-400 hover:text-[#00d4ff] transition-colors">My Repos</a>
        <a href="/knowledge" class="text-slate-400 hover:text-[#00d4ff] transition-colors">Knowledge Base</a>
        <a href="/settings" class="text-[#00d4ff] font-medium border-b-2 border-[#00d4ff] pb-0.5">Settings</a>
        <a href="/auth/logout" class="text-slate-400 hover:text-[#00d4ff] transition-colors">Logout</a>
        <div class="flex items-center gap-2 ml-2 pl-4 border-l border-slate-700/50">
          <img src="{{ user.github_avatar_url }}" alt="avatar" class="w-8 h-8 rounded-full ring-2 ring-[#00d4ff]/30" />
          <span class="text-slate-300 text-sm">{{ user.github_login }}</span>
        </div>
      </nav>

      <!-- Mobile hamburger button -->
      <button id="mobile-menu-btn" class="md:hidden flex flex-col gap-1.5 p-2 rounded-lg hover:bg-white/10 transition-colors" aria-label="Toggle menu">
        <span class="w-5 h-0.5 bg-white transition-all"></span>
        <span class="w-5 h-0.5 bg-white transition-all"></span>
        <span class="w-5 h-0.5 bg-white transition-all"></span>
      </button>
    </div>

    <!-- Mobile dropdown menu -->
    <div id="mobile-menu" class="hidden md:hidden absolute top-full left-0 right-0 z-40 border-b border-[#00d4ff]/20" style="background: rgba(10,15,30,0.97); backdrop-filter: blur(12px);">
      <nav class="max-w-7xl mx-auto px-6 py-4 flex flex-col gap-1">
        <a href="/dashboard" class="px-4 py-3 rounded-lg text-sm text-slate-400 hover:text-[#00d4ff] hover:bg-white/5 transition-colors">Dashboard</a>
        <a href="/repos" class="px-4 py-3 rounded-lg text-sm text-slate-400 hover:text-[#00d4ff] hover:bg-white/5 transition-colors">My Repos</a>
        <a href="/knowledge" class="px-4 py-3 rounded-lg text-sm text-slate-400 hover:text-[#00d4ff] hover:bg-white/5 transition-colors">Knowledge Base</a>
        <a href="/settings" class="px-4 py-3 rounded-lg text-sm text-[#00d4ff] hover:bg-white/5 transition-colors">Settings</a>
        <a href="/auth/logout" class="px-4 py-3 rounded-lg text-sm text-slate-400 hover:text-[#00d4ff] hover:bg-white/5 transition-colors">Logout</a>
      </nav>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-6 py-8 space-y-8">

    <h1 class="text-2xl font-bold text-white">API Settings</h1>

    <!-- Flash -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const container = document.getElementById('flash');
        if (params.get('success')) {
          container.innerHTML = `<div class="bg-[#00ff88]/10 border border-[#00ff88]/30 text-[#00ff88] px-4 py-3 rounded-lg text-sm">Settings saved successfully.</div>`;
        }
      });
    </script>
    <div id="flash"></div>

    <form method="POST" action="/settings" class="glass-card p-8 space-y-6">

      <!-- OpenRouter -->
      <div class="space-y-4">
        <h2 class="text-xs font-semibold uppercase tracking-[0.2em] text-[#00d4ff]/60">OpenRouter</h2>

        <div>
          <label class="block text-sm text-slate-300 mb-1">API Key</label>
          <div class="flex gap-2 items-center">
            <input type="password" name="openrouter_api_key" placeholder="sk-or-..."
                   class="flex-1 bg-[#0a0f1e] border border-slate-700 text-white rounded-lg px-4 py-2 text-sm placeholder-slate-500 focus:outline-none focus:border-[#00d4ff] focus:ring-1 focus:ring-[#00d4ff]/30 font-mono" />
            {% if settings.openrouter_api_key_masked %}
            <button type="button" onclick="clearKey('openrouter_api_key', this)"
                    class="px-3 py-2 text-xs text-slate-400 hover:text-red-400 border border-slate-600 hover:border-red-500/50 rounded-lg transition-colors whitespace-nowrap">
              Clear key
            </button>
            {% endif %}
          </div>
          {% if settings.openrouter_api_key_masked %}
            <p class="text-xs text-slate-500 mt-1">Current: {{ settings.openrouter_api_key_masked }}</p>
          {% else %}
            <p class="text-xs text-slate-500 mt-1">No key set — using system default</p>
          {% endif %}
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">Model</label>
          <input type="text" name="openrouter_model" value="{{ settings.openrouter_model }}"
                 class="w-full bg-[#0a0f1e] border border-slate-700 text-white rounded-lg px-4 py-2 text-sm placeholder-slate-500 focus:outline-none focus:border-[#00d4ff] focus:ring-1 focus:ring-[#00d4ff]/30 font-mono" />
        </div>
      </div>

      <!-- OpenAI -->
      <div class="space-y-4">
        <h2 class="text-xs font-semibold uppercase tracking-[0.2em] text-[#00d4ff]/60">OpenAI</h2>

        <div>
          <label class="block text-sm text-slate-300 mb-1">API Key</label>
          <div class="flex gap-2 items-center">
            <input type="password" name="openai_api_key" placeholder="sk-..."
                   class="flex-1 bg-[#0a0f1e] border border-slate-700 text-white rounded-lg px-4 py-2 text-sm placeholder-slate-500 focus:outline-none focus:border-[#00d4ff] focus:ring-1 focus:ring-[#00d4ff]/30 font-mono" />
            {% if settings.openai_api_key_masked %}
            <button type="button" onclick="clearKey('openai_api_key', this)"
                    class="px-3 py-2 text-xs text-slate-400 hover:text-red-400 border border-slate-600 hover:border-red-500/50 rounded-lg transition-colors whitespace-nowrap">
              Clear key
            </button>
            {% endif %}
          </div>
          {% if settings.openai_api_key_masked %}
            <p class="text-xs text-slate-500 mt-1">Current: {{ settings.openai_api_key_masked }}</p>
          {% else %}
            <p class="text-xs text-slate-500 mt-1">No key set — using system default</p>
          {% endif %}
        </div>

        <div>
          <label class="block text-sm text-slate-300 mb-1">Embedding Model</label>
          <input type="text" name="openai_embedding_model" value="{{ settings.openai_embedding_model }}"
                 class="w-full bg-[#0a0f1e] border border-slate-700 text-white rounded-lg px-4 py-2 text-sm placeholder-slate-500 focus:outline-none focus:border-[#00d4ff] focus:ring-1 focus:ring-[#00d4ff]/30 font-mono" />
        </div>
      </div>

      <p class="text-xs text-slate-500">Leave key fields empty to keep existing keys. Use "Clear key" to remove a saved key.</p>

      <button type="submit"
              class="bg-[#00d4ff] text-[#0a0f1e] font-bold px-6 py-2.5 rounded-lg text-sm transition-all hover:shadow-[0_0_20px_rgba(0,212,255,0.5)]">
        Save Settings
      </button>

    </form>

  </main>

  <footer class="border-t border-[#00d4ff]/10 mt-16 px-6 py-5">
    <div class="max-w-7xl mx-auto text-center text-xs text-slate-500">
      Powered by LangGraph + FastAPI
    </div>
  </footer>

  <script>
    function clearKey(fieldName, btn) {
      const input = document.querySelector(`[name="${fieldName}"]`);
      input.value = '__CLEAR__';
      input.type = 'text';
      input.placeholder = 'Key will be removed on save';
      input.classList.add('text-red-400');
      btn.textContent = 'Undo';
      btn.onclick = () => undoClear(fieldName, btn);
    }

    function undoClear(fieldName, btn) {
      const input = document.querySelector(`[name="${fieldName}"]`);
      input.value = '';
      input.type = 'password';
      input.placeholder = fieldName.includes('openrouter') ? 'sk-or-...' : 'sk-...';
      input.classList.remove('text-red-400');
      btn.textContent = 'Clear key';
      btn.onclick = () => clearKey(fieldName, btn);
    }
  </script>

  <script>
    const btn = document.getElementById('mobile-menu-btn');
    const menu = document.getElementById('mobile-menu');
    if (btn && menu) {
      btn.addEventListener('click', () => menu.classList.toggle('hidden'));
      menu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => menu.classList.add('hidden')));
    }
  </script>

</body>
</html>
