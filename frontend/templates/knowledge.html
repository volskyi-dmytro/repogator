<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ app_name }} â€” Knowledge Base</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png" />
  <link rel="shortcut icon" href="/static/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Space Grotesk', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          }
        }
      }
    }
  </script>
  <style>
    body {
      background-color: #0a0f1e;
      background-image: radial-gradient(circle, rgba(0,212,255,0.18) 1px, transparent 1px);
      background-size: 32px 32px;
    }
    .glass-card {
      background: rgba(10,15,30,0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(0,212,255,0.15);
      border-radius: 12px;
    }
    .glass-header {
      background: rgba(10,15,30,0.85);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(0,212,255,0.1);
    }
    .badge-collection { background: rgba(0,212,255,0.1); color: #00d4ff; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(0,212,255,0.3); }
    .status-badge-ingested { background: rgba(0,255,136,0.1); color: #00ff88; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(0,255,136,0.3); }
    .status-badge-pending { background: rgba(245,158,11,0.1); color: #f59e0b; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(245,158,11,0.3); }
    .status-badge-failed { background: rgba(239,68,68,0.1); color: #f87171; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(239,68,68,0.3); }
  </style>
</head>
<body class="min-h-screen text-slate-100 font-sans">

  <!-- Header -->
  <header class="glass-header px-6 py-4 sticky top-0 z-50 relative">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="/dashboard" class="flex items-center gap-2 text-2xl font-bold tracking-tight">
          <img src="/static/logo-128.png" class="h-9 w-9 object-contain" alt="RepoGator logo" />
          <span class="text-white">{{ app_name }}</span>
        </a>
      </div>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="/dashboard" class="text-slate-400 hover:text-[#00d4ff] transition-colors">Dashboard</a>
        <a href="/repos" class="text-slate-400 hover:text-[#00d4ff] transition-colors">My Repos</a>
        <a href="/knowledge" class="text-[#00d4ff] font-medium border-b-2 border-[#00d4ff] pb-0.5">Knowledge Base</a>
        <a href="/settings" class="text-slate-400 hover:text-[#00d4ff] transition-colors">Settings</a>
        {% if user.is_admin %}
        <a href="/admin" class="text-amber-400 hover:text-amber-300 font-medium transition-colors">Admin</a>
        {% endif %}
        <a href="/auth/logout" class="text-slate-400 hover:text-[#00d4ff] transition-colors">Logout</a>
        <div class="flex items-center gap-2 ml-2 pl-4 border-l border-slate-700/50">
          <img src="{{ user.github_avatar_url }}" alt="avatar" class="w-8 h-8 rounded-full ring-2 ring-[#00d4ff]/30" />
          <span class="text-slate-300 text-sm">{{ user.github_login }}</span>
        </div>
      </nav>

      <!-- Mobile hamburger button -->
      <button id="mobile-menu-btn" class="md:hidden flex flex-col gap-1.5 p-2 rounded-lg hover:bg-white/10 transition-colors" aria-label="Toggle menu">
        <span class="w-5 h-0.5 bg-white transition-all"></span>
        <span class="w-5 h-0.5 bg-white transition-all"></span>
        <span class="w-5 h-0.5 bg-white transition-all"></span>
      </button>
    </div>

    <!-- Mobile dropdown menu -->
    <div id="mobile-menu" class="hidden md:hidden absolute top-full left-0 right-0 z-40 border-b border-[#00d4ff]/20" style="background: rgba(10,15,30,0.97); backdrop-filter: blur(12px);">
      <nav class="max-w-7xl mx-auto px-6 py-4 flex flex-col gap-1">
        <a href="/dashboard" class="px-4 py-3 rounded-lg text-sm text-slate-400 hover:text-[#00d4ff] hover:bg-white/5 transition-colors">Dashboard</a>
        <a href="/repos" class="px-4 py-3 rounded-lg text-sm text-slate-400 hover:text-[#00d4ff] hover:bg-white/5 transition-colors">My Repos</a>
        <a href="/knowledge" class="px-4 py-3 rounded-lg text-sm text-[#00d4ff] hover:bg-white/5 transition-colors">Knowledge Base</a>
        <a href="/settings" class="px-4 py-3 rounded-lg text-sm text-slate-400 hover:text-[#00d4ff] hover:bg-white/5 transition-colors">Settings</a>
        {% if user.is_admin %}
        <a href="/admin" class="px-4 py-3 rounded-lg text-sm text-amber-400 hover:text-amber-300 font-medium hover:bg-white/5 transition-colors">Admin</a>
        {% endif %}
        <a href="/auth/logout" class="px-4 py-3 rounded-lg text-sm text-slate-400 hover:text-[#00d4ff] hover:bg-white/5 transition-colors">Logout</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8 space-y-8">

    <h1 class="text-2xl font-bold text-white">Knowledge Base</h1>

    <!-- Add Document -->
    <div class="glass-card p-6">
      <h2 class="text-xs font-semibold uppercase tracking-[0.2em] text-[#00d4ff]/60 mb-4">Add Document</h2>

      <!-- Tab Bar -->
      <div class="flex gap-4 border-b border-[#00d4ff]/10 mb-4">
        <button id="btn-upload-tab" onclick="switchTab('upload')" class="text-[#00d4ff] font-medium pb-2 border-b-2 border-[#00d4ff] text-sm transition-colors">Upload File</button>
        <button id="btn-url-tab" onclick="switchTab('url')" class="text-slate-400 pb-2 border-b-2 border-transparent text-sm transition-colors hover:text-[#00d4ff]">Add URL</button>
      </div>

      <!-- Upload File Tab -->
      <div id="tab-upload">
        <form id="upload-form" class="flex flex-col gap-3">
          <div class="flex flex-col sm:flex-row gap-3">
            <input type="file" name="file" accept=".md,.txt,.pdf"
                   class="flex-1 bg-[#0a0f1e] border border-slate-700 text-white rounded-lg px-4 py-2 text-sm file:mr-4 file:py-1 file:px-3 file:rounded file:border-0 file:text-sm file:bg-[#00d4ff]/10 file:text-[#00d4ff] hover:file:bg-[#00d4ff]/20 focus:outline-none focus:border-[#00d4ff] focus:ring-1 focus:ring-[#00d4ff]/30" required />
            <select name="collection_type" class="bg-[#0a0f1e] border border-slate-700 text-white rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-[#00d4ff] focus:ring-1 focus:ring-[#00d4ff]/30">
              <option value="requirements">Requirements</option>
              <option value="code_review">Code Review</option>
              <option value="docs">Documentation</option>
              <option value="general">General</option>
            </select>
            <button type="submit" class="bg-[#00d4ff] text-[#0a0f1e] font-bold px-6 py-2 rounded-lg text-sm transition-all hover:shadow-[0_0_20px_rgba(0,212,255,0.5)]">Upload</button>
          </div>
          <div id="upload-status" class="hidden text-sm"></div>
        </form>
      </div>

      <!-- Add URL Tab -->
      <div id="tab-url" class="hidden">
        <form id="url-form" class="flex flex-col gap-3">
          <div class="flex flex-col sm:flex-row gap-3">
            <input type="url" id="url-input" placeholder="https://example.com/docs/guide"
                   class="flex-1 bg-[#0a0f1e] border border-slate-700 text-white rounded-lg px-4 py-2 text-sm placeholder-slate-500 focus:outline-none focus:border-[#00d4ff] focus:ring-1 focus:ring-[#00d4ff]/30 font-mono" required />
            <select id="url-collection" class="bg-[#0a0f1e] border border-slate-700 text-white rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-[#00d4ff] focus:ring-1 focus:ring-[#00d4ff]/30">
              <option value="requirements">Requirements</option>
              <option value="code_review">Code Review</option>
              <option value="docs">Documentation</option>
              <option value="general">General</option>
            </select>
            <button type="submit" class="bg-[#00d4ff] text-[#0a0f1e] font-bold px-6 py-2 rounded-lg text-sm transition-all hover:shadow-[0_0_20px_rgba(0,212,255,0.5)] whitespace-nowrap">Fetch &amp; Index</button>
          </div>
          <div id="url-status" class="hidden text-sm"></div>
        </form>
      </div>
    </div>

    <!-- My Documents -->
    <section>
      <h2 class="text-xs font-semibold uppercase tracking-[0.2em] text-[#00d4ff]/60 mb-4">My Documents</h2>
      <div class="glass-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-[#00d4ff]/10 text-left">
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Title</th>
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Collection</th>
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Source</th>
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Chunks</th>
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Status</th>
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Added</th>
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="my-docs-tbody" class="divide-y divide-white/5"></tbody>
          </table>
        </div>
        <div id="my-docs-empty" class="hidden px-4 py-12 text-center text-slate-500 text-sm">
          No documents yet. Add files or URLs above to teach RepoGator your team's standards.
        </div>
      </div>
    </section>

    <!-- Auto-ingested from Repos -->
    <section>
      <h2 class="text-xs font-semibold uppercase tracking-[0.2em] text-[#00d4ff]/60 mb-4">Auto-ingested from Repos</h2>
      <div class="glass-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-[#00d4ff]/10 text-left">
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Title</th>
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Repo</th>
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Collection</th>
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Chunks</th>
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Status</th>
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Added</th>
                <th class="px-4 py-3 text-xs font-semibold text-[#00d4ff] uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="auto-docs-tbody" class="divide-y divide-white/5"></tbody>
          </table>
        </div>
        <div id="auto-docs-empty" class="hidden px-4 py-12 text-center text-slate-500 text-sm">
          No auto-ingested docs yet. Add a repo to trigger automatic documentation indexing.
        </div>
      </div>
    </section>

  </main>

  <footer class="border-t border-[#00d4ff]/10 mt-16 px-6 py-5">
    <div class="max-w-7xl mx-auto text-center text-xs text-slate-500">
      Powered by LangGraph + FastAPI
    </div>
  </footer>

  <script>
    const COLLECTION_LABELS = {
      requirements: 'Requirements',
      code_review: 'Code Review',
      docs: 'Documentation',
      general: 'General'
    };

    function escapeHtml(str) {
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    async function loadDocs() {
      const res = await fetch('/knowledge/list');
      const docs = await res.json();

      const myDocs = docs.filter(d => d.source_type !== 'github_auto');
      const autoDocs = docs.filter(d => d.source_type === 'github_auto');

      renderMyDocs(myDocs);
      renderAutoDocs(autoDocs);
    }

    function renderMyDocs(docs) {
      const tbody = document.getElementById('my-docs-tbody');
      const emptyState = document.getElementById('my-docs-empty');
      if (docs.length === 0) {
        tbody.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      emptyState.classList.add('hidden');
      tbody.innerHTML = docs.map(d => `
        <tr class="hover:bg-white/5 hover:border-l-2 hover:border-l-[#00d4ff] transition-colors">
          <td class="px-4 py-3 text-slate-200">${escapeHtml(d.title)}</td>
          <td class="px-4 py-3"><span class="badge-collection">${COLLECTION_LABELS[d.collection_type] || d.collection_type}</span></td>
          <td class="px-4 py-3 text-slate-400 text-sm">${d.source_type === 'url' ? 'URL' : 'Upload'}</td>
          <td class="px-4 py-3 text-slate-300">${d.chunk_count}</td>
          <td class="px-4 py-3"><span class="status-badge-${d.status}">${d.status}</span></td>
          <td class="px-4 py-3 text-slate-400 text-sm font-mono">${d.created_at}</td>
          <td class="px-4 py-3">
            <button onclick="deleteDoc('${d.id}', '${escapeHtml(d.title).replace(/'/g, "\\'")}')" class="border border-red-500/50 text-red-400 hover:bg-red-500/10 text-sm px-3 py-1 rounded-lg transition-colors">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function renderAutoDocs(docs) {
      const tbody = document.getElementById('auto-docs-tbody');
      const emptyState = document.getElementById('auto-docs-empty');
      if (docs.length === 0) {
        tbody.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      emptyState.classList.add('hidden');
      tbody.innerHTML = docs.map(d => {
        const repoMatch = d.source_url ? d.source_url.match(/github\.com\/([^/]+\/[^/]+)/) : null;
        const repoName = repoMatch ? repoMatch[1] : (d.source_url || '\u2014');
        return `
          <tr class="hover:bg-white/5 hover:border-l-2 hover:border-l-[#00d4ff] transition-colors">
            <td class="px-4 py-3 text-slate-200">${escapeHtml(d.title)}</td>
            <td class="px-4 py-3 text-slate-400 text-sm">${escapeHtml(repoName)}</td>
            <td class="px-4 py-3"><span class="badge-collection">${COLLECTION_LABELS[d.collection_type] || d.collection_type}</span></td>
            <td class="px-4 py-3 text-slate-300">${d.chunk_count}</td>
            <td class="px-4 py-3"><span class="status-badge-${d.status}">${d.status}</span></td>
            <td class="px-4 py-3 text-slate-400 text-sm font-mono">${d.created_at}</td>
            <td class="px-4 py-3">
              <button onclick="deleteDoc('${d.id}', '${escapeHtml(d.title).replace(/'/g, "\\'")}')" class="border border-red-500/50 text-red-400 hover:bg-red-500/10 text-sm px-3 py-1 rounded-lg transition-colors">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function deleteDoc(docId, docTitle) {
      const label = docTitle ? `"${docTitle}"` : 'this document';
      if (!confirm(`Remove ${label} from your knowledge base?\n\nThis will delete all indexed chunks and cannot be undone.`)) return;
      const res = await fetch(`/knowledge/${docId}`, { method: 'DELETE' });
      const data = await res.json();
      if (data.success) loadDocs();
      else alert('Delete failed: ' + (data.error || 'Unknown error'));
    }

    function switchTab(tab) {
      document.getElementById('tab-upload').classList.toggle('hidden', tab !== 'upload');
      document.getElementById('tab-url').classList.toggle('hidden', tab !== 'url');
      document.getElementById('btn-upload-tab').classList.toggle('text-[#00d4ff]', tab === 'upload');
      document.getElementById('btn-upload-tab').classList.toggle('text-slate-400', tab !== 'upload');
      document.getElementById('btn-upload-tab').classList.toggle('border-[#00d4ff]', tab === 'upload');
      document.getElementById('btn-upload-tab').classList.toggle('border-transparent', tab !== 'upload');
      document.getElementById('btn-url-tab').classList.toggle('text-[#00d4ff]', tab === 'url');
      document.getElementById('btn-url-tab').classList.toggle('text-slate-400', tab !== 'url');
      document.getElementById('btn-url-tab').classList.toggle('border-[#00d4ff]', tab === 'url');
      document.getElementById('btn-url-tab').classList.toggle('border-transparent', tab !== 'url');
    }

    document.getElementById('upload-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const status = document.getElementById('upload-status');
      status.textContent = 'Uploading...';
      status.className = 'text-slate-400 text-sm mt-2';
      status.classList.remove('hidden');

      const formData = new FormData(e.target);
      try {
        const res = await fetch('/knowledge/upload', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
          status.textContent = '\u2713 Indexed ' + data.chunk_count + ' chunks';
          status.className = 'text-[#00ff88] text-sm mt-2';
          e.target.reset();
          loadDocs();
        } else {
          status.textContent = '\u2717 ' + (data.error || 'Upload failed');
          status.className = 'text-red-400 text-sm mt-2';
        }
      } catch (err) {
        status.textContent = '\u2717 Network error';
        status.className = 'text-red-400 text-sm mt-2';
      }
    });

    document.getElementById('url-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const status = document.getElementById('url-status');
      status.textContent = 'Fetching and indexing...';
      status.className = 'text-slate-400 text-sm mt-2';
      status.classList.remove('hidden');

      const url = document.getElementById('url-input').value;
      const collection_type = document.getElementById('url-collection').value;
      try {
        const res = await fetch('/knowledge/url', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ url, collection_type })
        });
        const data = await res.json();
        if (data.success) {
          status.textContent = '\u2713 Indexed ' + data.chunk_count + ' chunks';
          status.className = 'text-[#00ff88] text-sm mt-2';
          e.target.reset();
          loadDocs();
        } else {
          status.textContent = '\u2717 ' + (data.error || 'Failed');
          status.className = 'text-red-400 text-sm mt-2';
        }
      } catch (err) {
        status.textContent = '\u2717 Network error';
        status.className = 'text-red-400 text-sm mt-2';
      }
    });

    document.addEventListener('DOMContentLoaded', loadDocs);

    const btn = document.getElementById('mobile-menu-btn');
    const menu = document.getElementById('mobile-menu');
    if (btn && menu) {
      btn.addEventListener('click', () => menu.classList.toggle('hidden'));
      menu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => menu.classList.add('hidden')));
    }
  </script>

</body>
</html>
